<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>Jump Frocest, Jump!</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
        }
        
        body {
            overflow: hidden;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%);
            font-family: 'Arial', sans-serif;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #gameCanvas {
            display: block;
            margin: 0 auto;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 100%);
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        #score {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 32px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }
        
        #coinsDisplay {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 10;
        }
        
        .control-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.3);
            border: 4px solid white;
            border-radius: 50%;
            font-size: 40px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        .control-btn:active {
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0.95);
        }
        
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 20;
        }
        
        #gameOver h1 {
            color: #ff6b6b;
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        #gameOver p {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        #gameOver button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }
        
        #gameOver button:hover {
            background: #45a049;
        }
        
        #gameOver button:nth-child(4) {
            background: #667eea;
        }
        
        #gameOver button:nth-child(4):hover {
            background: #5568d3;
        }
        
        #mainMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 30;
        }
        
        #mainMenu h1 {
            color: #FFD700;
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
        }
        
        .menu-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 24px;
            border-radius: 15px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            display: block;
            width: 250px;
            margin: 15px auto;
        }
        
        .menu-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }
        
        .menu-btn:active {
            transform: translateY(0);
        }
        
        .menu-btn:disabled {
            background: linear-gradient(135deg, #999 0%, #666 100%);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #characterSelect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 30;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        #characterSelect h2 {
            color: #FFD700;
            font-size: 36px;
            margin-bottom: 30px;
        }
        
        .character-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .character-option {
            width: 120px;
            height: 120px;
            border: 4px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .character-option:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,0.2);
        }
        
        .character-option.selected {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            background: rgba(255,255,255,0.3);
        }
        
        .character-option.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .character-option.locked::after {
            content: 'üîí';
            position: absolute;
            font-size: 40px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .character-option img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        #characterCard {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 40;
            display: none;
            min-width: 400px;
            max-width: 500px;
        }
        
        #characterCard h2 {
            color: #FFD700;
            font-size: 32px;
            margin-bottom: 20px;
        }
        
        #characterCard img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 20px 0;
        }
        
        .ability-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .ability-title {
            color: #FFD700;
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .ability-description {
            color: white;
            font-size: 16px;
            line-height: 1.5;
        }
        
        .ability-locked {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .unlock-btn {
            background: #FFD700;
            color: black;
            border: none;
            padding: 10px 30px;
            font-size: 18px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
        
        .unlock-btn:hover {
            background: #FFA500;
        }
        
        .unlock-btn:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }
        
        #leaderboardMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 30;
            display: none;
            min-width: 400px;
        }
        
        #leaderboardMenu h2 {
            color: #FFD700;
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        #creditsMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 30;
            display: none;
            min-width: 400px;
        }
        
        #changelogMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 40px 40px 20px 40px;
            border-radius: 20px;
            text-align: center;
            z-index: 30;
            display: none;
            min-width: 600px;
            max-width: 80vw;
            max-height: 80vh;
            display: none;
        }
        
        #changelogMenu h2 {
            color: #FFD700;
            font-size: 36px;
            margin-bottom: 20px;
        }
        
        #changelogContent {
            max-height: 50vh;
            overflow: hidden;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        
        .scroll-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px;
            font-size: 28px;
            border-radius: 50%;
            cursor: pointer;
            margin: 15px auto;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .scroll-btn:active {
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .scroll-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .changelog-version {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            text-align: left;
        }
        
        .changelog-version h3 {
            color: #FFD700;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .changelog-version h4 {
            color: #667eea;
            font-size: 18px;
            margin: 15px 0 10px 0;
        }
        
        .changelog-version ul {
            color: white;
            margin-left: 20px;
            line-height: 1.6;
        }
        
        .changelog-version li {
            margin: 5px 0;
        }
            display: none;
            min-width: 400px;
        }
        
        .version-label {
            position: absolute;
            top: 20px;
            right: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: bold;
            z-index: 100;
        }
        
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 4px solid #FFD700;
        }
        
        .leaderboard-rank {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            min-width: 50px;
        }
        
        .leaderboard-score {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .coin-counter {
            position: absolute;
            top: 70px;
            left: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .menu-coin-display {
            background: rgba(255, 215, 0, 0.2);
            padding: 15px 25px;
            border-radius: 15px;
            border: 3px solid #FFD700;
            font-size: 28px;
            color: #FFD700;
            font-weight: bold;
            margin: 20px auto;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="mainMenu">
        <div class="version-label">ver. 2.0.4b</div>
        <img src="https://i.imgur.com/m0pvm23.png" alt="Jump Frocest, Jump!" style="max-width: 90%; height: auto; margin-bottom: 20px;">
        <div class="menu-coin-display">
            üí∞ <span id="menuCoins">0</span> Monete
        </div>
        <button class="menu-btn" onclick="startGame()">Inizia a Giocare</button>
        <button class="menu-btn" onclick="showLeaderboard()">üèÜ Classifica Top 5</button>
        <button class="menu-btn" onclick="showChangelog()">üìã Changelog</button>
        <button class="menu-btn" onclick="showCredits()">üë®‚Äçüíª Crediti</button>
        <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 20px; max-width: 300px;">
            üíª PC: Usa frecce ‚Üê‚Üí o tasti A/D<br>
            üì± Mobile: Usa i pulsanti touch
        </p>
    </div>
    
    <div id="characterSelect">
        <div class="version-label">ver. 2.0.4b</div>
        <h2>Scegli il tuo Frociest! üí¶</h2>
        <div class="character-grid">
            <div class="character-option" onclick="selectCharacter('ruben', this)">
                <img src="https://i.imgur.com/gf2NFrI.png" alt="Ruben">
            </div>
            <div class="character-option" onclick="selectCharacter('vale', this)">
                <img src="https://i.imgur.com/cdpQskO.png" alt="Vale">
            </div>
            <div class="character-option" onclick="selectCharacter('poz', this)">
                <img src="https://i.imgur.com/x1erzzE.png" alt="Poz">
            </div>
            <div class="character-option" onclick="selectCharacter('jules', this)">
                <img src="https://i.imgur.com/yW2HGFC.png" alt="Jules">
            </div>
            <div class="character-option locked" id="refestOption" onclick="selectCharacter('refest', this)">
                <img src="https://i.imgur.com/paBjBaO.jpg" alt="Refest">
            </div>
        </div>
        <button class="menu-btn" onclick="backToMainMenu()">Indietro</button>
    </div>
    
    <div id="characterCard">
        <div class="version-label">ver. 2.0.4b</div>
        <h2 id="cardCharacterName"></h2>
        <img id="cardCharacterImg" src="" alt="">
        <div class="ability-section">
            <div class="ability-title" id="cardAbilityName"></div>
            <div class="ability-description" id="cardAbilityDesc"></div>
            <div id="cardAbilityStatus"></div>
        </div>
        <button class="menu-btn" onclick="confirmCharacter()">Conferma Personaggio</button>
        <button class="menu-btn" onclick="backToCharacterSelect()">Indietro</button>
    </div>
    
    <div id="leaderboardMenu">
        <div class="version-label">ver. 2.0.4b</div>
        <h2>üèÜ Top 5 Record</h2>
        <div id="leaderboardList" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0; max-height: 400px; overflow-y: auto;">
            <!-- La classifica verr√† riempita dinamicamente -->
        </div>
        <button class="menu-btn" onclick="closeLeaderboard()">Indietro</button>
    </div>
    
    <div id="creditsMenu">
        <div class="version-label">ver. 2.0.4b</div>
        <h2 style="color: #FFD700; font-size: 36px; margin-bottom: 30px;">Crediti</h2>
        <p style="color: white; font-size: 24px; margin-bottom: 20px;">developed by</p>
        <img src="https://i.imgur.com/N5L5BNN.png" alt="Flying Carpet" style="max-width: 200px; height: auto; margin-bottom: 30px;">
        <button class="menu-btn" onclick="closeCredits()">Indietro</button>
    </div>
    
    <div id="changelogMenu">
        <div class="version-label">ver. 2.0.4bb</div>
        <h2>üìã Changelog</h2>
        
        <div id="changelogContent">
            <div class="changelog-version">
                <h3>‚≠ê ver. 2.0.4bb (Corrente)</h3>
                <h4>üêõ Bug Fix</h4>
                <ul>
                    <li>üîß Bug minori risolti</li>
                    <li>üì± Migliorato scroll su touchscreen</li>
                    <li>‚¨áÔ∏è Aggiunti pulsanti di navigazione</li>
                </ul>
            </div>
            
            <div class="changelog-version">
                <h3>ver. 2.0.4b</h3>
                <h4>‚ú® Nuove Funzionalit√†</h4>
                <ul>
                    <li>üìã Aggiunto menu Changelog completo</li>
                    <li>üìö Storico di tutti gli aggiornamenti consultabile</li>
                    <li>üé® Interfaccia dedicata per la cronologia versioni</li>
                </ul>
            </div>
            
            <div class="changelog-version">
                <h3>ver. 2.0.3</h3>
                <h4>‚öñÔ∏è Bilanciamento</h4>
                <ul>
                    <li>üí∞ Costo abilit√†: 250 ‚Üí 200 monete (-20%)</li>
                    <li>üíé Costo Refest: 2500 ‚Üí 3000 monete (+20%)</li>
                    <li>üéØ Abilit√† Refest: nuovo costo 200 monete</li>
                    <li>üîê Abilit√† Refest sbloccabile solo dopo tutte le altre</li>
                </ul>
                <h4>üìà Gameplay</h4>
                <ul>
                    <li>üìä Pedane monouso aumentano progressivamente (15%‚Üí45%)</li>
                    <li>üìè Distanza piattaforme aumentata: 80-140px</li>
                    <li>‚ö° Ruben e Vale attivi da subito (0m)</li>
                    <li>üîÑ Cooldown abilit√† ogni 1500m esatti (non cumulabile)</li>
                </ul>
            </div>
            
            <div class="changelog-version">
                <h3>ver. 2.0.1 / b-2.0.1</h3>
                <h4>üéÆ Sistema Completo</h4>
                <ul>
                    <li>üí∞ Sistema monete con salvataggio permanente</li>
                    <li>üé™ Pedane monouso (si distruggono dopo uso)</li>
                    <li>üìè Distanza pedane aumentata (90px)</li>
                    <li>ü¶∏ Sistema abilit√† per tutti i personaggi</li>
                    <li>üîì Refest sbloccabile (2500 monete)</li>
                    <li>üìã Schede dettagliate personaggi</li>
                </ul>
                <h4>ü¶∏‚Äç‚ôÇÔ∏è Abilit√† Personaggi</h4>
                <ul>
                    <li>Ruben - "Katso in Q-lo": Salvataggio da game over</li>
                    <li>Vale - "Who says i'm gae?": 11¬∞ salto triplo</li>
                    <li>Poz - "You are gae": Pedane monouso indistruttibili</li>
                    <li>Jules - "Why are you gae?": 5% chance bonus monete x10</li>
                    <li>Refest - "IL BUCO DEL Q-LO": Tutte le abilit√†</li>
                </ul>
            </div>
            
            <div class="changelog-version">
                <h3>ver. 1.2.1</h3>
                <h4>üéÆ Ottimizzazioni</h4>
                <ul>
                    <li>üì± Ottimizzato per Safari iOS</li>
                    <li>‚å®Ô∏è Controlli tastiera: WASD + Frecce</li>
                    <li>üéØ Sensibilit√† ridotta 5% (velocit√†: 8 ‚Üí 7.6)</li>
                    <li>üèÜ Classifica ridotta: Top 10 ‚Üí Top 5</li>
                    <li>üè∑Ô∏è Label versione in tutti i menu</li>
                    <li>üë®‚Äçüíª Menu crediti aggiunto</li>
                    <li>üë§ Refest aggiunto come 5¬∞ personaggio</li>
                </ul>
            </div>
            
            <div class="changelog-version">
                <h3>ver. 1.2.0</h3>
                <h4>üì± Safari & Mobile</h4>
                <ul>
                    <li>üì± Supporto completo Safari iOS</li>
                    <li>üîß Meta tag iOS specifici</li>
                    <li>üìê Safe area per notch iPhone</li>
                    <li>‚úã Touch event ottimizzati</li>
                    <li>‚ö° Hardware acceleration</li>
                    <li>üö´ Prevenzione zoom doppio tap</li>
                </ul>
            </div>
            
            <div class="changelog-version">
                <h3>ver. 1.1.0</h3>
                <h4>üéÆ Gameplay Base</h4>
                <ul>
                    <li>üéØ Sistema salto automatico</li>
                    <li>üèÉ Piattaforme normali e booster</li>
                    <li>üîÑ Piattaforme mobili (40%)</li>
                    <li>üìú Scroll infinito camera</li>
                    <li>üîÅ Wrap-around schermo</li>
                    <li>üë• 5 personaggi selezionabili</li>
                    <li>üèÜ Sistema punteggio e classifica</li>
                    <li>üéµ Effetti sonori (Tone.js)</li>
                    <li>üíæ Salvataggio locale (localStorage)</li>
                </ul>
            </div>
        </div>
        
        <button class="scroll-btn" id="scrollDownBtn" onclick="scrollChangelogDown()">‚ñº</button>
        <button class="menu-btn" onclick="closeChangelog()">Indietro</button>
    </div>
    
    <div id="score">Altezza: 0m</div>
    <div id="coinsDisplay" style="display: none;">üí∞ <span id="gameCoins">0</span></div>
    <div id="gameOver">
        <div class="version-label">ver. 2.0.4b</div>
        <h1>Game Over!</h1>
        <p id="finalScore"></p>
        <p id="coinsEarned" style="color: #FFD700;"></p>
        <button onclick="restartGame()">Gioca Ancora</button>
        <button onclick="backToMenu()">Menu Principale</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="controls">
        <div class="control-btn" id="leftBtn">‚óÑ</div>
        <div class="control-btn" id="rightBtn">‚ñ∫</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        
        // Funzione per ottenere le dimensioni corrette su iOS Safari
        function getViewportSize() {
            if (window.visualViewport) {
                return {
                    width: window.visualViewport.width,
                    height: window.visualViewport.height
                };
            }
            return {
                width: window.innerWidth,
                height: window.innerHeight
            };
        }
        
        function resizeCanvas() {
            const viewport = getViewportSize();
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.width = viewport.width + 'px';
            canvas.style.height = viewport.height + 'px';
        }
        
        resizeCanvas();
        
        // Sistema monete
        let totalCoins = parseInt(localStorage.getItem('totalCoins') || '0');
        let sessionCoins = 0;
        
        // Sistema personaggi e abilit√†
        const characters = {
            ruben: {
                name: 'Ruben',
                url: 'https://i.imgur.com/gf2NFrI.png',
                abilityName: 'Katso in Q-lo',
                abilityDesc: 'Una volta ogni 1500m, previene un game over fornendo un super salto doppio',
                unlocked: false,
                price: 200
            },
            vale: {
                name: 'Vale',
                url: 'https://i.imgur.com/cdpQskO.png',
                abilityName: 'Who says i\'m gae?',
                abilityDesc: 'Una volta ogni 1500m, dopo 10 super salti, l\'11¬∞ √® triplo',
                unlocked: false,
                price: 200
            },
            poz: {
                name: 'Poz',
                url: 'https://i.imgur.com/x1erzzE.png',
                abilityName: 'You are gae',
                abilityDesc: 'Le pedane monouso non si distruggono',
                unlocked: false,
                price: 200
            },
            jules: {
                name: 'Jules',
                url: 'https://i.imgur.com/yW2HGFC.png',
                abilityName: 'Why are you gae?',
                abilityDesc: 'Possibilit√† di ottenere bonus monete',
                unlocked: false,
                price: 200
            },
            refest: {
                name: 'Refest',
                url: 'https://i.imgur.com/paBjBaO.jpg',
                abilityName: 'LO VOLETE VEDERE IL BUCO DEL Q-LO?!',
                abilityDesc: 'Ha tutte le abilit√† dei personaggi precedenti',
                unlocked: false,
                isCharacterLocked: true,
                price: 2000
            }
        };
        
        // Carica stato abilit√†
        const savedAbilities = localStorage.getItem('unlockedAbilities');
        if (savedAbilities) {
            const unlocked = JSON.parse(savedAbilities);
            Object.keys(unlocked).forEach(char => {
                if (characters[char]) {
                    characters[char].unlocked = unlocked[char];
                }
            });
        }
        
        const savedRefest = localStorage.getItem('refestUnlocked');
        if (savedRefest === 'true') {
            characters.refest.isCharacterLocked = false;
        }
        
        let selectedCharacter = 'ruben';
        let selectedCharacterData = characters.ruben;
        
        // Abilit√† attive
        let abilityCounters = {
            rubenUsed: false,
            rubenDistance: 0,
            valeUsed: false,
            valeDistance: 0,
            valeBoostCount: 0
        };
        
        // Impostazioni di gioco
        let soundEnabled = true;
        let playerColor = '#FF4444';
        
        // Immagini dei personaggi
        const characterImages = {};
        Object.keys(characters).forEach(key => {
            characterImages[key] = new Image();
            characterImages[key].src = characters[key].url;
        });
        
        let playerImage = characterImages.ruben;
        let imageLoaded = false;
        
        playerImage.onload = () => {
            imageLoaded = true;
        };
        
        function updateMenuCoins() {
            document.getElementById('menuCoins').textContent = totalCoins;
        }
        
        function updateRefestOption() {
            const refestDiv = document.getElementById('refestOption');
            if (characters.refest.isCharacterLocked) {
                refestDiv.classList.add('locked');
            } else {
                refestDiv.classList.remove('locked');
            }
        }
        
        updateMenuCoins();
        updateRefestOption();
        
        function startGame() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('characterSelect').style.display = 'block';
        }
        
        function selectCharacter(charKey, element) {
            const char = characters[charKey];
            
            // Se √® Refest e bloccato, chiedi di sbloccarlo
            if (charKey === 'refest' && char.isCharacterLocked) {
                if (totalCoins >= char.price) {
                    if (confirm(`Sbloccare Refest per ${char.price} monete?`)) {
                        totalCoins -= char.price;
                        localStorage.setItem('totalCoins', totalCoins);
                        char.isCharacterLocked = false;
                        localStorage.setItem('refestUnlocked', 'true');
                        updateMenuCoins();
                        updateRefestOption();
                        showCharacterCard(charKey);
                    }
                } else {
                    alert(`Servono ${char.price} monete per sbloccare Refest! Ne hai ${totalCoins}`);
                }
                return;
            }
            
            showCharacterCard(charKey);
        }
        
        function showCharacterCard(charKey) {
            selectedCharacter = charKey;
            selectedCharacterData = characters[charKey];
            
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('characterCard').style.display = 'block';
            
            document.getElementById('cardCharacterName').textContent = selectedCharacterData.name;
            document.getElementById('cardCharacterImg').src = selectedCharacterData.url;
            document.getElementById('cardAbilityName').textContent = selectedCharacterData.abilityName;
            document.getElementById('cardAbilityDesc').textContent = selectedCharacterData.abilityDesc;
            
            const statusDiv = document.getElementById('cardAbilityStatus');
            if (selectedCharacterData.unlocked) {
                statusDiv.innerHTML = '<p style="color: #4CAF50; font-weight: bold;">‚úì Abilit√† Sbloccata</p>';
            } else {
                // Per Refest, verifica che tutte le altre abilit√† siano sbloccate
                if (charKey === 'refest') {
                    const allOthersUnlocked = characters.ruben.unlocked && 
                                             characters.vale.unlocked && 
                                             characters.poz.unlocked && 
                                             characters.jules.unlocked;
                    
                    if (!allOthersUnlocked) {
                        statusDiv.innerHTML = `
                            <p class="ability-locked">üîí Abilit√† Bloccata</p>
                            <p style="color: #ff6b6b; font-size: 14px; margin-top: 10px;">
                                Sblocca prima tutte le abilit√† degli altri personaggi!
                            </p>
                        `;
                        return;
                    }
                }
                
                statusDiv.innerHTML = `
                    <p class="ability-locked">üîí Abilit√† Bloccata</p>
                    <button class="unlock-btn" onclick="unlockAbility()" id="unlockBtn">
                        Sblocca (${selectedCharacterData.price} üí∞)
                    </button>
                `;
                
                if (totalCoins < selectedCharacterData.price) {
                    document.getElementById('unlockBtn').disabled = true;
                }
            }
        }
        
        function unlockAbility() {
            if (totalCoins >= selectedCharacterData.price) {
                totalCoins -= selectedCharacterData.price;
                localStorage.setItem('totalCoins', totalCoins);
                selectedCharacterData.unlocked = true;
                
                // Salva stato
                const unlocked = {};
                Object.keys(characters).forEach(key => {
                    unlocked[key] = characters[key].unlocked;
                });
                localStorage.setItem('unlockedAbilities', JSON.stringify(unlocked));
                
                updateMenuCoins();
                showCharacterCard(selectedCharacter);
            }
        }
        
        function backToCharacterSelect() {
            document.getElementById('characterCard').style.display = 'none';
            document.getElementById('characterSelect').style.display = 'block';
        }
        
        function confirmCharacter() {
            playerImage = characterImages[selectedCharacter];
            imageLoaded = playerImage.complete;
            
            document.getElementById('characterCard').style.display = 'none';
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('score').style.display = 'block';
            document.getElementById('coinsDisplay').style.display = 'flex';
            
            // Reset abilit√† counters
            abilityCounters = {
                rubenUsed: false,
                rubenDistance: 0,
                valeUsed: false,
                valeDistance: 0,
                valeBoostCount: 0
            };
            
            sessionCoins = 0;
            updateGameCoins();
            
            initSounds();
            gameRunning = true;
            gameLoop();
        }
        
        function backToMainMenu() {
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
        }
        
        function backToMenu() {
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            document.getElementById('score').style.display = 'none';
            document.getElementById('coinsDisplay').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
            
            gameRunning = false;
            score = 0;
            maxHeight = 0;
            player.x = canvas.width / 2;
            player.y = canvas.height - 150;
            player.velocityY = 0;
            player.velocityX = 0;
            platforms = [];
            coins = [];
            sessionCoins = 0;
            
            platforms.push({
                x: canvas.width / 2 - platformWidth / 2,
                y: canvas.height - 100,
                width: platformWidth,
                height: platformHeight,
                moving: false,
                direction: 1,
                speed: 0,
                type: 'normal'
            });
        }
        
        // Sistema classifica
        const characterNamesMap = {
            'ruben': 'Ruben',
            'vale': 'Vale',
            'poz': 'Poz',
            'jules': 'Jules',
            'refest': 'Refest'
        };
        
        function getLeaderboard() {
            const scores = localStorage.getItem('jumpFrocestScores');
            return scores ? JSON.parse(scores) : [];
        }
        
        function saveScore(score, character) {
            let leaderboard = getLeaderboard();
            leaderboard.push({
                score: Math.floor(score / 10),
                date: new Date().toLocaleDateString(),
                character: characterNamesMap[character] || 'Frociest',
                characterImg: characters[character].url
            });
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 5);
            localStorage.setItem('jumpFrocestScores', JSON.stringify(leaderboard));
        }
        
        function showLeaderboard() {
            const leaderboard = getLeaderboard();
            const listDiv = document.getElementById('leaderboardList');
            
            if (leaderboard.length === 0) {
                listDiv.innerHTML = '<p style="color: white; padding: 20px;">Nessun record ancora! Gioca per entrare nella top 5!</p>';
            } else {
                listDiv.innerHTML = leaderboard.map((entry, index) => `
                    <div class="leaderboard-entry">
                        <span class="leaderboard-rank">#${index + 1}</span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${entry.characterImg || ''}" alt="${entry.character || 'Frociest'}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">
                            <span>${entry.character || 'Frociest'}</span>
                        </div>
                        <span>${entry.date || ''}</span>
                        <span class="leaderboard-score">${entry.score}m</span>
                    </div>
                `).join('');
            }
            
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('leaderboardMenu').style.display = 'block';
        }
        
        function closeLeaderboard() {
            document.getElementById('leaderboardMenu').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
        }
        
        function showCredits() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('creditsMenu').style.display = 'block';
        }
        
        function closeCredits() {
            document.getElementById('creditsMenu').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
        }
        
        function showChangelog() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('changelogMenu').style.display = 'block';
            // Reset scroll position
            document.getElementById('changelogContent').scrollTop = 0;
        }
        
        function closeChangelog() {
            document.getElementById('changelogMenu').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
        }
        
        function scrollChangelogDown() {
            const content = document.getElementById('changelogContent');
            content.scrollTop += 200; // Scroll di 200px alla volta
        }
        
        // Inizializza suoni
        let soundsReady = false;
        let jumpSound, boostSound, gameOverSound, coinSound;
        
        async function initSounds() {
            if (soundsReady) return;
            
            await Tone.start();
            
            jumpSound = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            
            boostSound = new Tone.Synth({
                oscillator: { type: 'square' },
                envelope: { attack: 0.001, decay: 0.2, sustain: 0.1, release: 0.2 }
            }).toDestination();
            
            gameOverSound = new Tone.Synth({
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.3 }
            }).toDestination();
            
            coinSound = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            
            soundsReady = true;
        }
        
        function playJump() {
            if (soundEnabled && soundsReady && jumpSound) {
                jumpSound.triggerAttackRelease('C5', '0.1');
            }
        }
        
        function playBoost() {
            if (soundEnabled && soundsReady && boostSound) {
                boostSound.triggerAttackRelease('C6', '0.2');
            }
        }
        
        function playGameOver() {
            if (soundEnabled && soundsReady && gameOverSound) {
                gameOverSound.triggerAttackRelease('C3', '0.3');
            }
        }
        
        function playCoin() {
            if (soundEnabled && soundsReady && coinSound) {
                coinSound.triggerAttackRelease('E6', '0.15');
            }
        }
        
        // Variabili del gioco
        let gameRunning = false;
        let score = 0;
        let maxHeight = 0;
        
        // Player
        const player = {
            x: canvas.width / 2,
            y: canvas.height - 150,
            width: 46.5,
            height: 46.5,
            velocityY: 0,
            velocityX: 0,
            jumping: false,
            gravity: 0.4,
            jumpPower: -12,
            speed: 7.6
        };
        
        // Piattaforme
        let platforms = [];
        const platformWidth = 80;
        const platformHeight = 15;
        
        // Monete
        let coins = [];
        const coinSize = 20;
        
        // Crea piattaforma iniziale
        platforms.push({
            x: canvas.width / 2 - platformWidth / 2,
            y: canvas.height - 100,
            width: platformWidth,
            height: platformHeight,
            moving: false,
            direction: 1,
            speed: 0,
            type: 'normal',
            used: false
        });
        
        // Controlli con pulsanti
        let moveLeft = false;
        let moveRight = false;
        
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        
        const passiveOptions = { passive: false };
        
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            initSounds();
            moveLeft = true;
        }, passiveOptions);
        
        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            moveLeft = false;
        }, passiveOptions);
        
        leftBtn.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            moveLeft = false;
        }, passiveOptions);
        
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            initSounds();
            moveRight = true;
        }, passiveOptions);
        
        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            moveRight = false;
        }, passiveOptions);
        
        rightBtn.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            moveRight = false;
        }, passiveOptions);
        
        // Mouse controls per desktop
        leftBtn.addEventListener('mousedown', () => {
            initSounds();
            moveLeft = true;
        });
        
        leftBtn.addEventListener('mouseup', () => {
            moveLeft = false;
        });
        
        leftBtn.addEventListener('mouseleave', () => {
            moveLeft = false;
        });
        
        rightBtn.addEventListener('mousedown', () => {
            initSounds();
            moveRight = true;
        });
        
        rightBtn.addEventListener('mouseup', () => {
            moveRight = false;
        });
        
        rightBtn.addEventListener('mouseleave', () => {
            moveRight = false;
        });
        
        // Controlli da tastiera (WASD e Frecce)
        document.addEventListener('keydown', (e) => {
            if(['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
                e.preventDefault();
            }
            
            initSounds();
            
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                moveLeft = true;
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                moveRight = true;
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                moveLeft = false;
            }
            if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                moveRight = false;
            }
        });
        
        // Crea nuove piattaforme
        function createPlatform(y) {
            const platform = {
                x: Math.random() * (canvas.width - platformWidth),
                y: y,
                width: platformWidth,
                height: platformHeight,
                moving: Math.random() < 0.4,
                direction: Math.random() < 0.5 ? -1 : 1,
                speed: Math.random() * 2 + 1,
                type: 'normal',
                used: false
            };
            
            // Calcola probabilit√† pedane monouso in base all'altezza
            const currentHeight = Math.floor(maxHeight / 10);
            let breakableChance = 0.15; // Base 15%
            
            // Aumenta progressivamente ogni 500m
            if (currentHeight > 500) {
                breakableChance += Math.floor((currentHeight - 500) / 500) * 0.05; // +5% ogni 500m
                breakableChance = Math.min(breakableChance, 0.45); // Massimo 45%
            }
            
            const rand = Math.random();
            if (rand < 0.15) {
                platform.type = 'booster';
                platform.width = 60;
            } else if (rand < 0.15 + breakableChance) {
                platform.type = 'breakable';
            }
            
            platforms.push(platform);
            
            // Spawna moneta vicino alla piattaforma (30% probabilit√†)
            if (Math.random() < 0.3) {
                coins.push({
                    x: platform.x + platform.width / 2,
                    y: platform.y - 40,
                    size: coinSize,
                    collected: false
                });
            }
        }
        
        // Genera piattaforme iniziali con pi√π spazio
        for (let i = 1; i < 10; i++) {
            createPlatform(canvas.height - 100 - i * 100); // Aumentato da 90 a 100
        }
        
        function updateGameCoins() {
            document.getElementById('gameCoins').textContent = sessionCoins;
        }
        
        // Update game
        function update() {
            if (!gameRunning) return;
            
            // Movimento del player con pulsanti
            if (moveLeft) {
                player.velocityX = -player.speed;
            } else if (moveRight) {
                player.velocityX = player.speed;
            } else {
                player.velocityX *= 0.8;
            }
            
            // Applica movimento
            player.x += player.velocityX;
            player.velocityY += player.gravity;
            player.y += player.velocityY;
            
            // Wrap around schermo
            if (player.x < -player.width) player.x = canvas.width;
            if (player.x > canvas.width) player.x = -player.width;
            
            // Collisione con piattaforme
            platforms.forEach(platform => {
                if (player.velocityY > 0 && 
                    player.x + player.width > platform.x &&
                    player.x < platform.x + platform.width &&
                    player.y + player.height > platform.y &&
                    player.y + player.height < platform.y + platform.height + 10) {
                    
                    // Gestione pedana monouso con abilit√† Poz
                    if (platform.type === 'breakable' && !platform.used) {
                        const hasPozAbility = (selectedCharacter === 'poz' && selectedCharacterData.unlocked) ||
                                            (selectedCharacter === 'refest' && characters.poz.unlocked);
                        
                        if (!hasPozAbility) {
                            platform.used = true;
                            platform.toRemove = true; // Marca per rimozione
                        }
                    }
                    
                    let jumpMultiplier = 1;
                    
                    // Abilit√† Vale
                    if ((selectedCharacter === 'vale' && selectedCharacterData.unlocked) ||
                        (selectedCharacter === 'refest' && characters.vale.unlocked)) {
                        if (platform.type === 'booster') {
                            abilityCounters.valeBoostCount++;
                            if (abilityCounters.valeBoostCount === 11 && !abilityCounters.valeUsed) {
                                jumpMultiplier = 3;
                                abilityCounters.valeBoostCount = 0;
                                abilityCounters.valeUsed = true;
                                abilityCounters.valeDistance = Math.floor(maxHeight / 10);
                            }
                        }
                    }
                    
                    if (platform.type === 'booster') {
                        player.velocityY = player.jumpPower * 1.8 * jumpMultiplier;
                        playBoost();
                    } else {
                        player.velocityY = player.jumpPower;
                        playJump();
                    }
                    
                    player.jumping = true;
                }
                
                // Muovi piattaforme
                if (platform.moving) {
                    platform.x += platform.speed * platform.direction;
                    if (platform.x < 0 || platform.x + platform.width > canvas.width) {
                        platform.direction *= -1;
                    }
                }
            });
            
            // Rimuovi pedane monouso usate
            platforms = platforms.filter(platform => !platform.toRemove);
            
            // Collisione con monete
            coins.forEach(coin => {
                if (!coin.collected &&
                    player.x + player.width > coin.x - coin.size &&
                    player.x < coin.x + coin.size &&
                    player.y + player.height > coin.y - coin.size &&
                    player.y < coin.y + coin.size) {
                    
                    coin.collected = true;
                    playCoin();
                    
                    // Abilit√† Jules - 5% chance di 10x monete
                    let coinsToAdd = 1;
                    if ((selectedCharacter === 'jules' && selectedCharacterData.unlocked) ||
                        (selectedCharacter === 'refest' && characters.jules.unlocked)) {
                        if (Math.random() < 0.05) {
                            coinsToAdd = 10;
                        }
                    }
                    
                    sessionCoins += coinsToAdd;
                    totalCoins += coinsToAdd;
                    localStorage.setItem('totalCoins', totalCoins);
                    updateGameCoins();
                    updateMenuCoins();
                }
            });
            
            // Reset abilit√† ogni 1500m dallo start (non cumulabile)
            const currentDistance = Math.floor(maxHeight / 10);
            const rubenCooldown = Math.floor(currentDistance / 1500) * 1500;
            const valeCooldown = Math.floor(currentDistance / 1500) * 1500;
            
            if (currentDistance >= rubenCooldown + 1500 && abilityCounters.rubenUsed) {
                abilityCounters.rubenUsed = false;
                abilityCounters.rubenDistance = rubenCooldown + 1500;
            }
            if (currentDistance >= valeCooldown + 1500 && abilityCounters.valeUsed) {
                abilityCounters.valeUsed = false;
                abilityCounters.valeDistance = valeCooldown + 1500;
            }
            
            // Scroll della camera quando il player sale
            if (player.y < canvas.height / 2) {
                const diff = canvas.height / 2 - player.y;
                player.y = canvas.height / 2;
                
                platforms.forEach(platform => {
                    platform.y += diff;
                });
                
                coins.forEach(coin => {
                    coin.y += diff;
                });
                
                score += diff;
                if (score > maxHeight) {
                    maxHeight = score;
                }
            }
            
            // Rimuovi piattaforme fuori schermo e crea nuove
            platforms = platforms.filter(platform => platform.y < canvas.height + 50);
            coins = coins.filter(coin => coin.y < canvas.height + 50);
            
            while (platforms.length < 15) {
                const lastPlatform = platforms[platforms.length - 1];
                const newY = lastPlatform.y - (Math.random() * 60 + 80); // Aumentata distanza: 80-140px
                createPlatform(newY);
            }
            
            // Game over se cadi
            if (player.y > canvas.height) {
                // Abilit√† Ruben - Salvataggio
                if ((selectedCharacter === 'ruben' && selectedCharacterData.unlocked) ||
                    (selectedCharacter === 'refest' && characters.ruben.unlocked)) {
                    if (!abilityCounters.rubenUsed) {
                        player.y = canvas.height / 2;
                        player.velocityY = player.jumpPower * 2;
                        abilityCounters.rubenUsed = true;
                        abilityCounters.rubenDistance = Math.floor(maxHeight / 10);
                        return;
                    }
                }
                
                endGame();
            }
        }
        
        // Draw game
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Disegna piattaforme
            platforms.forEach(platform => {
                // Non disegnare pedane monouso gi√† usate (stanno per essere rimosse)
                if (platform.type === 'breakable' && platform.used) {
                    return;
                }
                
                if (platform.type === 'booster') {
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    ctx.fillStyle = '#FFA500';
                    ctx.fillRect(platform.x + 5, platform.y + 3, platform.width - 10, platform.height - 6);
                    
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
                    for (let i = 0; i < 3; i++) {
                        const px = platform.x + Math.random() * platform.width;
                        const py = platform.y + platform.height + Math.random() * 20;
                        ctx.fillRect(px, py, 3, 3);
                    }
                } else if (platform.type === 'breakable') {
                    ctx.fillStyle = '#D2691E';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    ctx.fillStyle = '#CD853F';
                    ctx.fillRect(platform.x + 3, platform.y + 3, platform.width - 6, platform.height - 6);
                } else {
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    ctx.fillStyle = '#A0522D';
                    ctx.fillRect(platform.x + 3, platform.y + 3, platform.width - 6, platform.height - 6);
                }
            });
            
            // Disegna monete
            coins.forEach(coin => {
                if (!coin.collected) {
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y, coin.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FFA500';
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y, coin.size * 0.6, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // Disegna player
            if (imageLoaded) {
                ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);
            } else {
                ctx.fillStyle = playerColor;
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2, player.y + player.height / 2, player.width / 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2 - 6, player.y + player.height / 2 - 4, 4, 0, Math.PI * 2);
                ctx.arc(player.x + player.width / 2 + 6, player.y + player.height / 2 - 4, 4, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(player.x + player.width / 2 - 6, player.y + player.height / 2 - 4, 2, 0, Math.PI * 2);
                ctx.arc(player.x + player.width / 2 + 6, player.y + player.height / 2 - 4, 2, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Update score display
            document.getElementById('score').textContent = `Altezza: ${Math.floor(maxHeight / 10)}m`;
        }
        
        // Game loop
        function gameLoop() {
            update();
            draw();
            if (gameRunning) {
                requestAnimationFrame(gameLoop);
            }
        }
        
        // Game over
        function endGame() {
            gameRunning = false;
            playGameOver();
            
            saveScore(maxHeight, selectedCharacter);
            
            document.getElementById('finalScore').textContent = `Altezza finale: ${Math.floor(maxHeight / 10)}m`;
            document.getElementById('coinsEarned').textContent = `üí∞ Monete guadagnate: ${sessionCoins}`;
            document.getElementById('gameOver').style.display = 'block';
        }
        
        // Restart
        function restartGame() {
            initSounds();
            gameRunning = true;
            score = 0;
            maxHeight = 0;
            sessionCoins = 0;
            updateGameCoins();
            
            player.x = canvas.width / 2;
            player.y = canvas.height - 150;
            player.velocityY = 0;
            player.velocityX = 0;
            platforms = [];
            coins = [];
            
            abilityCounters = {
                rubenUsed: false,
                rubenDistance: 0,
                valeUsed: false,
                valeDistance: 0,
                valeBoostCount: 0
            };
            
            platforms.push({
                x: canvas.width / 2 - platformWidth / 2,
                y: canvas.height - 100,
                width: platformWidth,
                height: platformHeight,
                moving: false,
                direction: 1,
                speed: 0,
                type: 'normal',
                used: false
            });
            
            for (let i = 1; i < 10; i++) {
                createPlatform(canvas.height - 100 - i * 90);
            }
            
            document.getElementById('gameOver').style.display = 'none';
            gameLoop();
        }
        
        // Gestione resize ottimizzata per Safari iOS
        function handleResize() {
            resizeCanvas();
            if (player.x > canvas.width) {
                player.x = canvas.width / 2;
            }
        }
        
        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', () => {
            setTimeout(handleResize, 100);
        });
        
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', handleResize);
        }
        
        // Previeni zoom su doppio tap in Safari iOS
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Nascondi controlli e score inizialmente
        document.getElementById('controls').style.display = 'none';
        document.getElementById('score').style.display = 'none';
    </script>
</body>
</html>